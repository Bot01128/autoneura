<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tu Nido Personalizado - {{ nombre_negocio }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='nido.css') }}">
    <!-- Estilos espec√≠ficos para el chat -->
    <style>
        .msg-ia { background-color: #e3f2fd; padding: 10px; border-radius: 10px; margin-bottom: 5px; text-align: left; }
        .msg-user { background-color: #f1f1f1; padding: 10px; border-radius: 10px; margin-bottom: 5px; text-align: right; }
        .typing { font-style: italic; color: #888; font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- SECCI√ìN 1: BIENVENIDA Y DIAGN√ìSTICO -->
        <div class="section">
            <h1>{{ contenido.diagnostico_titulo if contenido else titulo_personalizado }}</h1>
            <p>{{ contenido.diagnostico_texto if contenido else 'Bienvenido a tu demostraci√≥n privada.' }}</p>
        </div>

        <div class="section">
            <h2>üîç Lo que hemos encontrado</h2>
            <p>{{ contenido.dolor_detectado if contenido else texto_diagnostico }}</p>
        </div>

        <!-- SECCI√ìN 2: LA SOLUCI√ìN (CONTENIDO DE VALOR) -->
        <div class="section">
            <h2>üí° Tu Plan de Acci√≥n</h2>
            <div style="background: #fff3cd; padding: 15px; border-left: 5px solid #ffc107; border-radius: 4px;">
                <p>{{ contenido.solucion_propuesta if contenido else texto_contenido_de_valor }}</p>
            </div>
        </div>

        <!-- SECCI√ìN 3: EL CHATBOT VENDEDOR (EL CEREBRO) -->
        <div class="section">
            <h2>ü§ñ Pru√©bame: Soy tu Nuevo Vendedor</h2>
            <p>He estudiado tu negocio. Intenta venderme algo o ponme objeciones.</p>
            
            <div class="live-chat-container">
                <div class="chat-window" id="chat-window-ia">
                    <div class="msg-ia">
                        Hola, soy el Agente IA de <strong>{{ nombre_negocio }}</strong>. 
                        {{ contenido.chat_opener if contenido else '¬øEn qu√© puedo ayudarte hoy?' }}
                    </div>
                </div>
                <form id="chat-form-ia" class="chat-input-area">
                    <input type="text" id="user-input-ia" placeholder="Escribe aqu√≠ (Ej: ¬øCu√°nto cuesta?)..." autocomplete="off">
                    <button type="submit" class="btn-3d">Enviar</button>
                </form>
            </div>
        </div>
        
        <!-- SECCI√ìN 4: CIERRE DE VENTA (HUMANO) -->
        <div class="section autoneura-promo-section">
            <h2>¬øTe gust√≥ c√≥mo trabaj√©?</h2>
            <p>Imagina tener a este agente trabajando para ti 24/7 sin descanso.</p>
            <a href="/" class="btn-promo btn-3d">QUIERO CONTRATAR A ESTA IA AHORA</a>
        </div>
        
    </div>

    <!-- === CEREBRO JAVASCRIPT DEL NIDO === -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatForm = document.getElementById('chat-form-ia');
            const userInput = document.getElementById('user-input-ia');
            const chatWindow = document.getElementById('chat-window-ia');
            
            // TOKEN DE SESI√ìN (Vital para saber qui√©n es el prospecto)
            const sessionToken = "{{ token_sesion }}";

            if (chatForm) {
                chatForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const text = userInput.value.trim();
                    if (!text) return;

                    // 1. Mostrar mensaje del usuario
                    const userDiv = document.createElement('div');
                    userDiv.className = 'msg-user';
                    userDiv.textContent = text;
                    chatWindow.appendChild(userDiv);
                    userInput.value = '';

                    // 2. Mostrar "Escribiendo..."
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'typing';
                    loadingDiv.textContent = 'Escribiendo...';
                    chatWindow.appendChild(loadingDiv);
                    chatWindow.scrollTop = chatWindow.scrollHeight;

                    try {
                        // 3. ENVIAR AL BACKEND (Nutridor)
                        const response = await fetch('/api/chat-nido', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                message: text, 
                                token: sessionToken // Enviamos el token para identificar al prospecto
                            })
                        });
                        
                        const data = await response.json();
                        
                        // 4. Mostrar respuesta de la IA
                        chatWindow.removeChild(loadingDiv); // Quitar "Escribiendo"
                        
                        const botDiv = document.createElement('div');
                        botDiv.className = 'msg-ia';
                        // Reemplazar saltos de l√≠nea por <br>
                        botDiv.innerHTML = data.respuesta ? data.respuesta.replace(/\n/g, '<br>') : "Disculpa, me desconect√© un momento.";
                        chatWindow.appendChild(botDiv);

                    } catch (error) {
                        chatWindow.removeChild(loadingDiv);
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'msg-ia';
                        errorDiv.style.color = 'red';
                        errorDiv.textContent = "Error de conexi√≥n. Intenta de nuevo.";
                        chatWindow.appendChild(errorDiv);
                    }
                    
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                });
            }
        });
    </script>
</body>
</html>
