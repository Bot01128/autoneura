<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Arquitecto - AutoNeura</title>
    <!-- Reutilizamos el CSS del cliente porque es bonito y consistente -->
    <link rel="stylesheet" href="{{ url_for('static', filename='client_style.css') }}">
    <style>
        /* Estilos espec√≠ficos para Admin */
        body { background-color: #1a1a1a; color: #e0e0e0; } /* Modo Oscuro Hacker */
        .top-bar { background-color: #2d2d2d; border-bottom: 1px solid #444; color: white; }
        .left-panel { background-color: #252525; border-right: 1px solid #444; color: white; }
        .right-panel { background-color: #1a1a1a; }
        
        .kpi-card { background-color: #333; border: 1px solid #555; }
        .kpi-title { color: #aaa; }
        .kpi-value { color: #4caf50; } /* Verde Matrix */
        
        .campaign-table { background-color: #2d2d2d; color: white; border: none; }
        .campaign-table th { background-color: #333; border-bottom: 2px solid #555; color: #aaa; }
        .campaign-table td { border-bottom: 1px solid #444; }
        .campaign-table tbody tr:hover { background-color: #383838; }
        
        .chat-messages { background-color: #2d2d2d; }
        .msg-assistant { background-color: #333; color: white; }
        .msg-user { background-color: #007bff; }
        input[type="text"] { background-color: #333; color: white; border: 1px solid #555; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo"><h2>AutoNeura <strong>[Modo Arquitecto]</strong></h2></div>
        <div class="user-info">
            <span>Bienvenido, Arquitecto</span>
            <button id="logout-btn" class="recharge-btn" style="background-color: #d32f2f;">Cerrar Sesi√≥n</button>
        </div>
    </div>
    <div class="container">
        <div class="left-panel">
            <div class="chat-header">
                <h2>Asistente de CEO</h2>
            </div>
            <div class="chat-window">
                <div class="chat-messages" id="chat-messages">
                    <p class="msg-assistant">Sistema Operativo. Conectado a la Base de Datos Maestra. ¬øQu√© deseas consultar hoy?</p>
                </div>
                <form id="chat-form" class="chat-input">
                    <input type="text" id="user-input" placeholder="Ej: Ingresos de este mes...">
                    <button id="send-btn" type="submit">Ejecutar</button>
                </form>
            </div>
        </div>
        <div class="right-panel">
            <div class="tab-nav">
                <button class="tab-button active" data-tab="dashboard-global">Dashboard Global</button>
                <button class="tab-button" data-tab="clientes">Clientes</button>
                <button class="tab-button" data-tab="campanas-todas">Todas las Campa√±as</button>
            </div>

            <!-- 1. DASHBOARD GLOBAL (REAL) -->
            <div class="tab-content" id="dashboard-global" style="display: block;">
                <h2>Resumen del Imperio</h2>
                <div class="kpi-container">
                    <div class="kpi-card">
                        <span class="kpi-title">üí∞ MRR (Mensual)</span>
                        <span class="kpi-value" id="kpi-mrr">$0.00</span>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-title">üë• Total Clientes</span>
                        <span class="kpi-value" id="kpi-clientes">0</span>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-title">üåé Data (Prospectos)</span>
                        <span class="kpi-value" id="kpi-data">0</span>
                    </div>
                    <div class="kpi-card">
                        <span class="kpi-title">‚ö° Campa√±as Activas</span>
                        <span class="kpi-value" id="kpi-activas">0</span>
                    </div>
                </div>
            </div>

            <!-- 2. CLIENTES (REAL) -->
            <div class="tab-content" id="clientes" style="display: none;">
                <h2>Gesti√≥n de Clientes</h2>
                <table class="campaign-table">
                    <thead><tr><th>Cliente</th><th>Email</th><th>Plan</th><th>Estado</th><th>Campa√±as</th></tr></thead>
                    <tbody id="lista-clientes-body">
                        <!-- Se llena con JS -->
                    </tbody>
                </table>
            </div>

            <!-- 3. TODAS LAS CAMPA√ëAS (Placeholder por ahora) -->
            <div class="tab-content" id="campanas-todas" style="display: none;">
                <h2>Visi√≥n de Rayos X (Todas las Campa√±as)</h2>
                <p>Aqu√≠ ver√°s todas las campa√±as de todos los clientes.</p>
                <!-- Se implementar√° en la fase de "Supervisi√≥n" -->
            </div>
        </div>
    </div>
  
   <!-- SCRIPT DE CONTROL DEL ARQUITECTO -->
   <script>
       document.addEventListener('DOMContentLoaded', async () => {
           // 1. CARGAR KPIS GLOBALES
           try {
               const res = await fetch('/api/admin/metricas-globales');
               const data = await res.json();
               
               document.getElementById('kpi-mrr').innerText = `$${data.mrr}`;
               document.getElementById('kpi-clientes').innerText = data.total_clientes;
               document.getElementById('kpi-data').innerText = data.total_prospectos;
               document.getElementById('kpi-activas').innerText = data.campanas_activas;
           } catch(e) {
               console.error("Error KPIs:", e);
           }

           // 2. CARGAR TABLA CLIENTES
           try {
               const res = await fetch('/api/admin/lista-clientes');
               const clientes = await res.json();
               const tbody = document.getElementById('lista-clientes-body');
               tbody.innerHTML = '';

               clientes.forEach(c => {
                   const tr = document.createElement('tr');
                   const estado = c.activo ? '<span style="color:#4caf50">‚óè Activo</span>' : '<span style="color:#f44336">‚óè Inactivo</span>';
                   tr.innerHTML = `
                       <td>${c.nombre}</td>
                       <td>${c.email}</td>
                       <td>${c.plan.toUpperCase()}</td>
                       <td>${estado}</td>
                       <td>${c.campanas}</td>
                   `;
                   tbody.appendChild(tr);
               });
           } catch(e) {
               console.error("Error Clientes:", e);
           }

           // 3. PESTA√ëAS
           const tabs = document.querySelectorAll('.tab-button');
           const contents = document.querySelectorAll('.tab-content');
           tabs.forEach(btn => {
               btn.addEventListener('click', () => {
                   contents.forEach(c => c.style.display = 'none');
                   tabs.forEach(t => t.classList.remove('active'));
                   document.getElementById(btn.dataset.tab).style.display = 'block';
                   btn.classList.add('active');
               });
           });

           // 4. CHAT ARQUITECTO (Igual que antes)
           const chatForm = document.getElementById('chat-form');
           const finalInput = document.getElementById('user-input');
           const chatMessages = document.getElementById('chat-messages');

           chatForm.addEventListener('submit', async (e) => {
               e.preventDefault();
               const text = finalInput.value.trim();
               if (!text) return;

               const userMsgDiv = document.createElement('p');
               userMsgDiv.className = 'msg-user';
               userMsgDiv.textContent = text;
               chatMessages.appendChild(userMsgDiv);
               finalInput.value = '';

               const loadingDiv = document.createElement('p');
               loadingDiv.className = 'msg-assistant';
               loadingDiv.textContent = 'Analizando...';
               chatMessages.appendChild(loadingDiv);
               
               try {
                   const response = await fetch('/api/chat-arquitecto', {
                       method: 'POST',
                       headers: { 'Content-Type': 'application/json' },
                       body: JSON.stringify({ message: text })
                   });
                   const data = await response.json();
                   loadingDiv.innerHTML = data.response.replace(/\n/g, '<br>');
               } catch (error) {
                   loadingDiv.textContent = "Error de conexi√≥n.";
               }
           });
       });
   </script>
</body>
</html>
