<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Comando - AutoNeura</title>
    <!-- Estilos oscuros profesionales -->
    <link rel="stylesheet" href="{{ url_for('static', filename='client_style.css') }}">
    <style>
        body { background-color: #121212; color: #e0e0e0; }
        .top-bar { background-color: #1e1e1e; border-bottom: 1px solid #333; }
        .left-panel { background-color: #181818; border-right: 1px solid #333; }
        .right-panel { background-color: #121212; }
        
        .kpi-card { background-color: #1e1e1e; border: 1px solid #333; }
        .kpi-title { color: #888; }
        .kpi-value { color: #4caf50; text-shadow: 0 0 10px rgba(76, 175, 80, 0.3); }
        
        .tab-nav button { color: #888; }
        .tab-nav button.active { color: #fff; border-bottom-color: #007bff; }
        
        /* Tablas Oscuras */
        .campaign-table { background-color: #1e1e1e; color: #ddd; }
        .campaign-table th { background-color: #252525; color: #fff; border-bottom: 2px solid #444; }
        .campaign-table td { border-bottom: 1px solid #333; }
        .campaign-table tr:hover { background-color: #2a2a2a; }

        /* Finanzas */
        .finance-positive { color: #4caf50; font-weight: bold; }
        .finance-negative { color: #f44336; font-weight: bold; }
        
        .gasto-form { background: #252525; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444; }
        input, select { background-color: #333; border: 1px solid #555; color: white; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo"><h2>AutoNeura <strong>[ADMIN]</strong></h2></div>
        <div class="user-info">
            <span>Arquitecto</span>
            <button id="logout-btn" class="recharge-btn" style="background-color: #d32f2f;">Salir</button>
        </div>
    </div>
    <div class="container">
        <!-- CHAT LATERAL -->
        <div class="left-panel">
            <div class="chat-header"><h2>Asistente CEO</h2></div>
            <div class="chat-window">
                <div class="chat-messages" id="chat-messages">
                    <p class="msg-assistant">Sistema Operativo. Conectado a la Base de Datos Maestra. 쯈u칠 deseas consultar hoy?</p>
                </div>
                <form id="chat-form" class="chat-input">
                    <input type="text" id="user-input" placeholder="Consulta SQL...">
                    <button id="send-btn" type="submit">Ejecutar</button>
                </form>
            </div>
        </div>

        <div class="right-panel">
            <!-- MEN칔 DE 5 PESTA칌AS -->
            <div class="tab-nav">
                <button class="tab-button active" data-tab="dashboard">游늵 Global</button>
                <button class="tab-button" data-tab="clientes">游논 Clientes</button>
                <button class="tab-button" data-tab="campanas">游닉 Campa침as</button>
                <button class="tab-button" data-tab="finanzas">游눯 Finanzas</button>
                <button class="tab-button" data-tab="monitor">丘뙖잺 Monitor</button>
            </div>

            <!-- 1. DASHBOARD GLOBAL -->
            <div class="tab-content" id="dashboard" style="display: block;">
                <h2>Signos Vitales</h2>
                <div class="kpi-container">
                    <div class="kpi-card"><span class="kpi-title">Ingresos Mensuales</span><span class="kpi-value" id="kpi-mrr">$0.00</span></div>
                    <div class="kpi-card"><span class="kpi-title">Clientes Totales</span><span class="kpi-value" id="kpi-clientes">0</span></div>
                    <div class="kpi-card"><span class="kpi-title">Prospectos Totales</span><span class="kpi-value" id="kpi-data">0</span></div>
                    <div class="kpi-card"><span class="kpi-title">Campa침as Activas</span><span class="kpi-value" id="kpi-activas">0</span></div>
                </div>
            </div>

            <!-- 2. CLIENTES -->
            <div class="tab-content" id="clientes" style="display: none;">
                <h2>Base de Datos de Clientes</h2>
                <table class="campaign-table">
                    <thead><tr><th>Nombre</th><th>Email</th><th>Plan</th><th>Estado</th><th>Campa침as</th></tr></thead>
                    <tbody id="lista-clientes"></tbody>
                </table>
            </div>

            <!-- 3. TODAS LAS CAMPA칌AS -->
            <div class="tab-content" id="campanas" style="display: none;">
                <h2>Visi칩n de Rayos X</h2>
                <p>Lista maestra de todas las campa침as del sistema.</p>
                <table class="campaign-table">
                    <thead><tr><th>Campa침a</th><th>Cliente</th><th>Estado</th><th>Prospectos</th></tr></thead>
                    <tbody id="lista-campanas">
                        <tr><td colspan="4">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 4. FINANZAS (NUEVO) -->
            <div class="tab-content" id="finanzas" style="display: none;">
                <h2>Tesorer칤a y Ganancias</h2>
                
                <!-- KPI DE GANANCIA NETA -->
                <div style="background: #1e1e1e; padding: 20px; border-radius: 8px; border: 1px solid #4caf50; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #4caf50; margin:0;">GANANCIA NETA REAL (Caja)</h3>
                    <h1 style="font-size: 3em; margin: 10px 0; color: white;" id="total-neto">$0.00</h1>
                </div>

                <!-- FORMULARIO DE GASTOS -->
                <div class="gasto-form">
                    <h4 style="margin-top:0;">游댮 Registrar Gasto Operativo</h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="gasto-concepto" placeholder="Ej: Recarga Apify" style="flex: 2;">
                        <input type="number" id="gasto-monto" placeholder="Monto ($)" style="flex: 1;">
                        <button class="recharge-btn" style="background-color: #f44336;" onclick="registrarGasto()">Registrar Salida</button>
                    </div>
                </div>

                <!-- TABLA HISTORIAL -->
                <h3>Libro Contable (칔ltimos 50 movimientos)</h3>
                <table class="campaign-table">
                    <thead><tr><th>Fecha</th><th>Tipo</th><th>Concepto</th><th>Monto Bruto</th><th>Neto</th></tr></thead>
                    <tbody id="tabla-finanzas"></tbody>
                </table>
            </div>

            <!-- 5. MONITOR DEL SISTEMA (NUEVO) -->
            <div class="tab-content" id="monitor" style="display: none;">
                <h2>Cuarto de M치quinas</h2>
                <div class="kpi-container">
                    <div class="kpi-card"><span class="kpi-title">Base de Datos</span><span class="kpi-value" id="status-db">...</span></div>
                    <div class="kpi-card"><span class="kpi-title">Google AI</span><span class="kpi-value" id="status-ai">...</span></div>
                    <div class="kpi-card"><span class="kpi-title">Apify Scraper</span><span class="kpi-value" id="status-apify">...</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT DEL ADMIN -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            
            // --- 1. CARGA INICIAL DE DATOS ---
            cargarKPIsGlobales();
            cargarClientes();
            cargarFinanzas();
            cargarMonitor();

            // --- 2. L칍GICA DE PESTA칌AS ---
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(btn => {
                btn.addEventListener('click', () => {
                    contents.forEach(c => c.style.display = 'none');
                    tabs.forEach(t => t.classList.remove('active'));
                    document.getElementById(btn.dataset.tab).style.display = 'block';
                    btn.classList.add('active');
                });
            });

            // --- 3. FUNCIONES DE CARGA ---
            async function cargarKPIsGlobales() {
                try {
                    const res = await fetch('/api/admin/metricas-globales');
                    const data = await res.json();
                    document.getElementById('kpi-mrr').innerText = `$${data.mrr}`;
                    document.getElementById('kpi-clientes').innerText = data.total_clientes;
                    document.getElementById('kpi-data').innerText = data.total_prospectos;
                    document.getElementById('kpi-activas').innerText = data.campanas_activas;
                } catch(e) { console.error(e); }
            }

            async function cargarClientes() {
                try {
                    const res = await fetch('/api/admin/lista-clientes');
                    const clientes = await res.json();
                    const tbody = document.getElementById('lista-clientes');
                    tbody.innerHTML = '';
                    clientes.forEach(c => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${c.nombre}</td><td>${c.email}</td><td>${c.plan}</td><td>${c.activo ? '游릭' : '游댮'}</td><td>${c.campanas}</td>`;
                        tbody.appendChild(tr);
                    });
                } catch(e) {}
            }

            async function cargarFinanzas() {
                try {
                    const res = await fetch('/api/admin/finanzas');
                    const data = await res.json();
                    
                    document.getElementById('total-neto').innerText = `$${data.total_neto.toFixed(2)}`;
                    
                    const tbody = document.getElementById('tabla-finanzas');
                    tbody.innerHTML = '';
                    
                    data.historial.forEach(h => {
                        const tr = document.createElement('tr');
                        const color = h.tipo === 'INGRESO' ? '#4caf50' : '#f44336';
                        tr.innerHTML = `
                            <td>${h.fecha}</td>
                            <td style="color:${color}; font-weight:bold;">${h.tipo}</td>
                            <td>${h.desc || h.categoria}</td>
                            <td>$${h.bruto}</td>
                            <td style="color:${color};">$${h.neto}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } catch(e) {}
            }

            async function cargarMonitor() {
                try {
                    const res = await fetch('/api/admin/monitor');
                    const data = await res.json();
                    document.getElementById('status-db').innerText = data.database;
                    document.getElementById('status-ai').innerText = data.google_ai;
                    document.getElementById('status-apify').innerText = data.apify;
                } catch(e) {}
            }

            // --- 4. CHAT ARQUITECTO ---
            const chatForm = document.getElementById('chat-form');
            if(chatForm) {
                const newForm = chatForm.cloneNode(true);
                chatForm.parentNode.replaceChild(newForm, chatForm);
                
                const finalForm = document.getElementById('chat-form');
                const finalInput = document.getElementById('user-input');
                const chatMessages = document.getElementById('chat-messages');

                finalForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const text = finalInput.value.trim();
                    if(!text) return;

                    const userMsg = document.createElement('p');
                    userMsg.className = 'msg-user';
                    userMsg.innerText = text;
                    chatMessages.appendChild(userMsg);
                    finalInput.value = '';

                    try {
                        const res = await fetch('/api/chat-arquitecto', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({message: text})
                        });
                        const data = await res.json();
                        const botMsg = document.createElement('p');
                        botMsg.className = 'msg-assistant';
                        botMsg.innerHTML = data.response.replace(/\n/g, '<br>');
                        chatMessages.appendChild(botMsg);
                    } catch(e) {}
                });
            }
        });

        // Funci칩n Global para registrar gasto
        async function registrarGasto() {
            const concepto = document.getElementById('gasto-concepto').value;
            const monto = document.getElementById('gasto-monto').value;
            
            if(!concepto || !monto) return alert("Llena los datos");

            if(confirm(`Registrar gasto de $${monto}? Esto restar치 de tu ganancia.`)) {
                await fetch('/api/admin/registrar-gasto', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({concepto, monto})
                });
                alert("Gasto registrado");
                location.reload(); 
            }
        }
    </script>
</body>
</html>
